version: '3.8'

services:
  azerothcore:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: azerothcore-wotlk:latest
    container_name: azerothcore-server
    hostname: azerothcore
    restart: unless-stopped
    
    ports:
      # Auth server port
      - "3724:3724"
      # World server port
      - "8085:8085"
      # MySQL (optional - for external database access)
      - "3306:3306"
    
    volumes:
      # Persist compiled binaries and data
      - azerothcore-data:/azerothcore/env/dist
      # Persist configuration files
      - azerothcore-etc:/azerothcore/env/dist/etc
      # Persist modules
      - azerothcore-modules:/azerothcore/modules
      # Persist database
      - azerothcore-db:/var/lib/mysql
      # Optional: Mount custom configs
      # - ./custom-configs:/azerothcore/custom-configs:ro
    
    environment:
      # Realm configuration
      - REALM_NAME=AzerothCore Docker Server
      # Database credentials
      - ACORE_USER=acore
      - ACORE_PASS=acore
      # Server bind address (0.0.0.0 for all interfaces)
      - SERVER_IP=0.0.0.0
      # Installation directory
      - INSTALL_DIR=/azerothcore
    
    networks:
      - azerothcore-network
    
    # Keep container running
    stdin_open: true
    tty: true
    
    # Resource limits (adjust based on your system)
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G
    
    # Health check
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8085"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 2m

# Named volumes for persistence
volumes:
  azerothcore-data:
    driver: local
  azerothcore-etc:
    driver: local
  azerothcore-modules:
    driver: local
  azerothcore-db:
    driver: local

# Custom network
networks:
  azerothcore-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
